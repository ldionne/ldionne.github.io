<%
require 'benchmark'
require 'open3'
require 'pathname'
require 'tilt'


def measure(namespace)
    template = Pathname.new('benchmark_2.erb.cpp').expand_path
    cpp = Pathname.new('__tmp.cpp').expand_path
    clang = "~/code/llvm/release/bin/clang++" # <- My own modified Clang
    command = "#{clang} -std=c++14 -o/dev/null -ftemplate-depth=-1 #{cpp}"

    times = []
    (0..1000).step(10).each do |n|
        puts "#{namespace}: #{n}/1000"
        code = Tilt::ERBTemplate.new(template).render(nil, input_size: n,
                                                           namespace: namespace)
        cpp.write(code)
        stdout, stderr, status = nil, nil, nil
        time = Benchmark.realtime {
            stdout, stderr, status = Open3.capture3(command)
        }
        raise "compilation error: #{stderr}\n\n#{code}" if not status.success?
        times << [n, time]
    end

    return times

ensure
    cpp.delete if cpp.exist?
end

%>

{
    "title": {
        "text": "Compile-time behavior of creating n tuples"
    },
    "xAxis": {
        "title": { "text": "Number of tuples" }
    },
    "series": [
        {
            "name": "atoms",
            "data": <%= measure('atoms') %>
        }, {
            "name": "flat",
            "data": <%= measure('flat') %>
        }, {
            "name": "lambda",
            "data": <%= measure('lambda') %>
        }, {
            "name": "raw",
            "data": <%= measure('raw') %>
        }, {
            "name": "baseline",
            "data": <%= measure('baseline') %>
        }
    ]
}