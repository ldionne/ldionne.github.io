<%
require 'benchmark'
require 'open3'
require 'pathname'
require 'tilt'


TUPLE_SIZE = 300
RANGE = (0..TUPLE_SIZE).step(5)

def measure(file)
    template = Pathname.new(file).expand_path
    cpp = Pathname.new('__tmp.cpp').expand_path
    command = "clang++ -std=c++14 -o/dev/null -ftemplate-depth=-1 #{cpp}"

    times = []
    RANGE.each do |n|
        code = Tilt::ERBTemplate.new(template).render(nil, input_size: n, tuple_size: TUPLE_SIZE)
        cpp.write(code)
        stdout, stderr, status = nil, nil, nil
        time = Benchmark.realtime {
            stdout, stderr, status = Open3.capture3(command)
        }
        raise "compilation error: #{stderr}\n\n#{code}" if not status.success?
        times << [n, time]
    end

    return times

ensure
    cpp.delete if cpp.exist?
end

%>

{
    "title": {
        "text": "Compile-time behaviour of get on a <%= TUPLE_SIZE %>-element tuple"
    },
    "xAxis": {
        "title": {
            "text": "Index"
        },
        "minTickInterval": 1
    },
    "series": [
        {
            "name": "atoms",
            "data": <%= measure('atoms.erb.cpp') %>
        }, {
            "name": "flat",
            "data": <%= measure('flat.erb.cpp') %>
        }, {
            "name": "lambda",
            "data": <%= measure('lambda.erb.cpp') %>
        }
    ]
}